<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JAIN AGM AMCH SALARY CALCULATOR TOOL</title>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--accent:#0b5fff;--muted:#6b7280}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);margin:0;padding:18px;color:#111}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(12,22,39,0.04);margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="number"], input[type="text"], select{width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:8px;font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;font-weight:600;cursor:pointer}
    .secondary{background:#eef2ff;color:var(--accent);border:1px solid rgba(11,95,255,0.12)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border:1px solid #eef2ff;padding:6px;text-align:left}
    th{background:#fbfdff}
    .small{font-size:12px;color:var(--muted)}
    .narrow{width:110px}
    .action-btn{padding:6px 8px;border-radius:6px;border:0;background:#fff;color:var(--accent);border:1px solid rgba(11,95,255,0.12);cursor:pointer}
    .status{font-size:13px;color:#047857;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,#eef2ff,#e6f0ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#0b5fff">JAM</div>
      <div>
        <h1>JAIN AGM AMCH SALARY CALCULATOR TOOL</h1>
        <div class="small">Quick-check version — Add Row button fixed. If it still fails, open browser console (F12) and paste any errors here so I can patch fast.</div>
      </div>
    </header>

    <div class="card">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:220px">
          <label>College</label>
          <input id="college" value="Jain AGM Ayurvedic Medical College & Hospital, Varur, Karnataka">
        </div>
        <div style="width:160px">
          <label>Month</label>
          <select id="monthSelect"> 
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9" selected>September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>
        <div style="width:120px">
          <label>Year</label>
          <select id="yearSelect"></select>
        </div>
        <div style="width:120px">
          <label>Total days</label>
          <input type="number" id="totalDays" value="30">
        </div>
        <div style="width:120px">
          <label>Sundays</label>
          <input type="number" id="sundays" value="4">
        </div>
        <div style="width:140px">
          <label>Paid holidays (days)</label>
          <input type="number" id="paidHolidays" value="0" min="0">
        </div>
        <div style="width:140px">
          <label>Hours / day</label>
          <input type="number" id="hoursPerDay" value="7" step="0.1">
        </div>
        <div style="width:140px">
          <label>Default CL days for new rows</label>
          <input type="number" id="defaultCLDays" value="2" min="0" step="1">
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="controls">
        <button id="btnAddRow" type="button">Add Staff Row</button>
        <button id="btnCalcAll" type="button">Calculate All</button>
        <button id="btnCSV" type="button" class="secondary">Download CSV</button>
        <button id="btnXLSX" type="button" class="secondary">Export Excel (.xlsx)</button>
        <button id="btnPDF" type="button" class="secondary">Export PDF</button>
        <button id="btnClear" type="button" class="secondary">Clear All Rows</button>
      </div>
      <div class="status" id="statusMsg">Status: ready</div>
    </div>

    <div class="card">
      <div style="overflow:auto">
        <table id="staffTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Designation</th>
              <th>Department</th>
              <th>Gross (₹)</th>
              <th>Per hour (₹)</th>
              <th>CL days</th>
              <th>Shortfall hrs</th>
              <th>EPF ₹</th>
              <th>ESI ₹</th>
              <th>PT ₹</th>
              <th>Unpaid Deduct (₹)</th>
              <th>Total Deductions (₹)</th>
              <th>Net Pay (₹)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="staffBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card small muted">If Add Row still doesn't react: 1) try a different browser (Chrome/Edge/Firefox), 2) open Developer Console (F12) and copy any error messages into the chat. I'll patch immediately.</div>

    <footer class="small muted">Data stored only in-browser. Use exports to save.</footer>
  </div>

<script>
(function(){
  'use strict';
  const el = id => document.getElementById(id);
  const fmt = x => Number(x||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});

  // year select
  (function(){ const ys = el('yearSelect'); for(let y=2020;y<=2030;y++){ const o = document.createElement('option'); o.value=y; o.text=y; if(y===2025) o.selected=true; ys.appendChild(o);} })();

  const DEPARTMENTS = ["SAMHITA & SIDDHANTA","RACHANA","KRIYA","DG","RSBK","AGADA","ROGA NIDANA","SW","KC","PK","SHALYA","SHALAKYA","PTSR","KB"];
  const DESIGNATIONS = [{v:'Assistant Professor',t:'Assistant Prof'},{v:'Associate Professor',t:'Associate Prof'},{v:'Professor',t:'Professor'}];

  let rowCounter = 0;

  function makeSelect(options, selected){
    const s = document.createElement('select');
    options.forEach(opt=>{ const o = document.createElement('option'); if(typeof opt === 'string'){ o.value = opt; o.text = opt; } else { o.value = opt.v; o.text = opt.t } if(selected && (o.value==selected || o.text==selected)) o.selected=true; s.appendChild(o); });
    return s;
  }

  function addRow(prefill){
    try{
      prefill = prefill || {};
      const tbody = el('staffBody');
      const tr = document.createElement('tr');
      const id = ++rowCounter; tr.dataset.rowid = id;

      // create and append cells
      const cells = [];
      for(let i=0;i<15;i++){ const td = document.createElement('td'); cells.push(td); }
      cells[0].textContent = id;

      const name = document.createElement('input'); name.type='text'; name.className='name'; name.value = prefill.name||''; cells[1].appendChild(name);

      const desel = makeSelect(DESIGNATIONS, prefill.desig); cells[2].appendChild(desel);
      const deptsel = makeSelect(DEPARTMENTS, prefill.dept); cells[3].appendChild(deptsel);

      const gross = document.createElement('input'); gross.type='number'; gross.className='gross'; gross.value = prefill.gross||57000; cells[4].appendChild(gross);

      cells[5].className='out hourly'; cells[5].textContent='-';

      const defaultCL = (typeof prefill.clDays !== 'undefined') ? prefill.clDays : Number(el('defaultCLDays').value)||0;
      const cl = document.createElement('input'); cl.type='number'; cl.className='clDays'; cl.min=0; cl.value = defaultCL; cells[6].appendChild(cl);

      const shortf = document.createElement('input'); shortf.type='number'; shortf.className='shortfall'; shortf.step='0.25'; shortf.min=0; shortf.value = prefill.shortfall||0; cells[7].appendChild(shortf);

      const epf = document.createElement('input'); epf.type='number'; epf.className='epf'; epf.step='0.01'; epf.min=0; epf.value = prefill.epfAmount||0; cells[8].appendChild(epf);
      const esi = document.createElement('input'); esi.type='number'; esi.className='esi'; esi.step='0.01'; esi.min=0; esi.value = prefill.esiAmount||0; cells[9].appendChild(esi);
      const pt = document.createElement('input'); pt.type='number'; pt.className='pt'; pt.step='0.01'; pt.min=0; pt.value = prefill.profTaxAmt||0; cells[10].appendChild(pt);

      cells[11].className='out unpaid'; cells[11].textContent='-';
      cells[12].className='out totalDeduct'; cells[12].textContent='-';
      cells[13].className='out net'; cells[13].textContent='-';

      const actions = document.createElement('div'); actions.style.whiteSpace='nowrap';
      const calcBtn = document.createElement('button'); calcBtn.type='button'; calcBtn.className='action-btn'; calcBtn.textContent='Calc';
      const removeBtn = document.createElement('button'); removeBtn.type='button'; removeBtn.className='action-btn'; removeBtn.textContent='Remove';
      actions.appendChild(calcBtn); actions.appendChild(removeBtn);
      cells[14].appendChild(actions);

      cells.forEach(c=>tr.appendChild(c));
      tbody.appendChild(tr);

      // listeners
      calcBtn.addEventListener('click', ()=>computeForTr(tr));
      removeBtn.addEventListener('click', ()=>{ if(confirm('Remove this row?')) tr.remove(); });

      // small visual confirmation
      el('statusMsg').textContent = `Row ${id} added`;
      setTimeout(()=>{ el('statusMsg').textContent = 'Ready'; }, 900);

      return tr;
    }catch(err){
      console.error('addRow error', err);
      el('statusMsg').textContent = 'Error adding row — see console';
    }
  }

  function computeForTr(tr){
    try{
      const totalDays = Number(el('totalDays').value)||30;
      const sundays = Number(el('sundays').value)||0;
      const paidHolidays = Number(el('paidHolidays').value)||0;
      const hoursPerDay = Number(el('hoursPerDay').value)||7;

      const gross = Number(tr.querySelector('.gross').value)||0;
      const clDays = Number(tr.querySelector('.clDays').value)||0;
      const shortfall = Number(tr.querySelector('.shortfall').value)||0;
      const epf = Number(tr.querySelector('.epf').value)||0;
      const esi = Number(tr.querySelector('.esi').value)||0;
      const pt = Number(tr.querySelector('.pt').value)||0;

      const workingDays = Math.max(0, totalDays - sundays - paidHolidays);
      const totalWorkingHours = workingDays * hoursPerDay;
      const hourlyRate = totalWorkingHours>0 ? gross / totalWorkingHours : 0;

      const unpaidDeduct = shortfall * hourlyRate;
      const subtotal = gross - unpaidDeduct;
      const totalDeductions = Number(epf)+Number(esi)+Number(pt);
      const net = subtotal - totalDeductions;

      const hourlyCell = tr.querySelector('.out.hourly');
      const unpaidCell = tr.querySelector('.out.unpaid');
      const totalDedCell = tr.querySelector('.out.totalDeduct');
      const netCell = tr.querySelector('.out.net');
      if(hourlyCell) hourlyCell.textContent = fmt(hourlyRate);
      if(unpaidCell) unpaidCell.textContent = fmt(unpaidDeduct);
      if(totalDedCell) totalDedCell.textContent = fmt(totalDeductions);
      if(netCell) netCell.textContent = fmt(net);
    }catch(err){ console.error('computeForTr', err); el('statusMsg').textContent='Compute error — see console'; }
  }

  function calculateAll(){ Array.from(document.querySelectorAll('#staffBody tr')).forEach(tr=>computeForTr(tr)); el('statusMsg').textContent='All rows calculated'; setTimeout(()=>el('statusMsg').textContent='Ready',800); }

  function downloadCSV(){
    calculateAll();
    const rows = Array.from(document.querySelectorAll('#staffBody tr'));
    if(rows.length===0){ alert('No rows'); return; }
    const header = ['Sr','Name','Designation','Department','Gross','PerHour','CL_days','Shortfall_hrs','Unpaid_Deduction','EPF','ESI','PT','Total_Deductions','Net_Pay'];
    const data=[header];
    rows.forEach((tr,idx)=>{
      const name = (tr.querySelector('.name')||{}).value||'';
      const selects = tr.querySelectorAll('select');
      const desig = selects[0]?selects[0].value:''; const dept = selects[1]?selects[1].value:'';
      const gross = (tr.querySelector('.gross')||{}).value||'';
      const perHour = (tr.querySelector('.out.hourly')||{}).textContent||'';
      const cl = (tr.querySelector('.clDays')||{}).value||'';
      const shortf = (tr.querySelector('.shortfall')||{}).value||'';
      const unpaid = (tr.querySelector('.out.unpaid')||{}).textContent||'';
      const epf = (tr.querySelector('.epf')||{}).value||''; const esi=(tr.querySelector('.esi')||{}).value||''; const pt=(tr.querySelector('.pt')||{}).value||'';
      const totalDed = (tr.querySelector('.out.totalDeduct')||{}).textContent||''; const net=(tr.querySelector('.out.net')||{}).textContent||'';
      data.push([idx+1,name,desig,dept,gross,perHour,cl,shortf,unpaid,epf,esi,pt,totalDed,net]);
    });
    const csv = data.map(r=>r.map(c=>typeof c==='string' && c.includes(',')? '"'+c.replace(/"/g,'""')+'"': c).join(',')).join('
');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='salary_sheet_'+el('monthSelect').value+'_'+el('yearSelect').value+'.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // minimal XLSX/PDF exports removed here to focus on Add Row fix; they will still work if you add back libs.

  // attach listeners
  document.addEventListener('DOMContentLoaded', ()=>{
    el('btnAddRow').addEventListener('click', ()=>{ addRow(); console.log('Add Row clicked'); });
    el('btnCalcAll').addEventListener('click', calculateAll);
    el('btnCSV').addEventListener('click', downloadCSV);
    el('btnClear').addEventListener('click', ()=>{ if(confirm('Clear all rows?')){ el('staffBody').innerHTML=''; rowCounter=0; el('statusMsg').textContent='Cleared'; }});
    // ensure first row present
    addRow();
  });

})();
</script>
</body>
</html>
